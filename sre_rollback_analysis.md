# SRE Agent 变更穿刺与回滚冲突分析 (Case Study)

**归档时间**: 2026-02-05
**背景**: 某用户在执行批量配置变更时遭遇“死亡螺旋”：
1. 变更失败 -> 回滚 -> 互斥锁导致回滚失败。
2. 用户跳过回滚重试，手动解除冲突 -> 系统错误判断为“继续执行”。
3. 第二批/第三批任务在错误状态下启动，且用户跳过报错，导致全集群故障。

---

## 💀 核心问题复盘 (Root Cause Analysis)

### 1. 状态机陷阱 (The "Continue" Trap)
*   **现象**: 当第一批次失败且回滚未成功时，人工解除互斥锁后，系统状态机默认流转为“继续执行下一批”，而非“重新回滚”或“暂停”。
*   **缺陷**: 系统缺乏**状态熔断**机制。在 Batch N 失败未修复（回滚未确认）的情况下，绝对禁止流转到 Batch N+1。

### 2. 回滚死锁 (Rollback Deadlock)
*   **现象**: 系统因“灰度任务超时”或“互斥锁”而拒绝回滚。
*   **缺陷**: 回滚通道与正向变更通道共享了锁资源。**救火通道（回滚）必须拥有最高优先级**，应具备 `Preemption`（抢占）或 `Force Release`（强制释放）能力。

### 3. 配置一致性缺失 (Config Drift)
*   **现象**: 回滚失败导致脏配置残留，后续批次在“脏环境”上继续叠加变更。
*   **缺陷**: 缺乏 **Pre-flight Check**（预检）。每一批次启动前，必须校验当前环境是否符合基线版本。

---

## 🛡️ SRE 改进与穿刺测试建议

### A. 回滚策略分级 (Rollback Conflict Policy)
不能简单地“一键强行”，应根据冲突类型分级处理：

#### Level 1: 软冲突 (Soft Conflict) -> **Auto-Force**
*   **类型**: 系统单据状态锁、非核心任务挂起。
*   **策略**: Agent 自动强杀旧任务，释放锁，执行回滚。

#### Level 2: 数据/版本冲突 (Drift Conflict) -> **Diff & Confirm**
*   **类型**: 环境中存在非预期的版本漂移（有人手动改过），强行回滚会导致改动丢失。
*   **策略**: 暂停并展示 Diff，要求用户签署“风险确认”后才执行强行回滚。

#### Level 3: 硬冲突 (Hard Conflict) -> **Fail Fast**
*   **类型**: 基础设施故障（磁盘满、API 挂）。
*   **策略**: 直接报警，人工介入。

### B. 穿刺测试场景 (Chaos Engineering Scenarios)

1.  **脏状态闭环测试**: 制造超时灰度任务 -> 发起回滚 -> 验证系统是否能强杀任务并回滚。
2.  **意图识别测试**: 任务失败锁死 -> 人工解锁 -> 验证系统下一步是“回滚”还是错误的“继续”。
3.  **配置漂移测试**: 手动修改环境配置 -> 执行变更失败 -> 回滚 -> 验证系统是否提示 Diff 风险。

---

## 💡 总结
**“强行回滚”不是开关，是一套决策逻辑。**
变更平台必须具备**防御性状态机**，不能让用户在修锁（解冲突）的时候，系统在后台把门（继续执行）给打开了。
